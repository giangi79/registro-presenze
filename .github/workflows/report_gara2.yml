name: Invio Report Gara 2 Automatico

on:
  schedule:
    - cron: '*/30 * * * *'
  workflow_dispatch: 

jobs:
  check-deadline:
    runs-on: ubuntu-latest
    steps:
      - name: Install jq
        run: sudo apt-get install jq -y

      - name: Esegui Script di Controllo
        run: |
          # Impostazione variabili
          SUPABASE_URL="https://jnfnfszekfstuoiemkgf.supabase.co"
          SUPABASE_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpuZm5mc3pla2ZzdHVvaWVta2dmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc4ODkzOTEsImV4cCI6MjA4MzQ2NTM5MX0.lh7eRFlg7nnI7kEzVPBL9kNyZWX-XFeWQxVbvmzRlvA"
          TELEGRAM_TOKEN="8441085660:AAEui_yfGnT_quKPHVx_wsslcuJtm3KbTOI"
          TELEGRAM_CHAT_ID="691756250"
          
          # 1. Recupera Configurazione
          CONFIG=$(curl -s -L "$SUPABASE_URL/rest/v1/config_gara2?select=*" \
            -H "apikey: $SUPABASE_KEY" \
            -H "Authorization: Bearer $SUPABASE_KEY")
          
          echo "Configurazione recuperata: $CONFIG"

          SCADENZA=$(echo $CONFIG | jq -r '.[] | select(.chiave=="scadenza_adesioni") | .valore')
          REPORT_SENT=$(echo $CONFIG | jq -r '.[] | select(.chiave=="report_sent") | .valore')
          TITOLO=$(echo $CONFIG | jq -r '.[] | select(.chiave=="titolo_gara") | .valore')

          if [ "$SCADENZA" == "null" ] || [ "$SCADENZA" == "" ]; then
            echo "Nessuna scadenza impostata."
            exit 0
          fi

          # 2. Controllo Tempo
          NOW=$(date +%s)
          DEADLINE_SEC=$(date -d "$SCADENZA" +%s)

          echo "Orario attuale: $NOW"
          echo "Scadenza (sec): $DEADLINE_SEC"

          if [ "$NOW" -ge "$DEADLINE_SEC" ] && [ "$REPORT_SENT" != "true" ]; then
            echo "Scadenza superata! Recupero atleti..."

            # 3. Recupera Atleti
            ATLETI=$(curl -s -L "$SUPABASE_URL/rest/v1/gara2?stato=eq.si&select=nome,categoria" \
              -H "apikey: $SUPABASE_KEY" \
              -H "Authorization: Bearer $SUPABASE_KEY")
            
            # 4. Formatta Messaggio
            MSG="üèÅ *ISCRIZIONI CHIUSE* %0AüèÜ *Evento:* $TITOLO %0A%0A"
            LISTA=$(echo $ATLETI | jq -r 'group_by(.categoria) | .[] | "*\(.[0].categoria):*\n\(map("- \(.nome) (partecipa)") | join("\n"))\n"' | sed 's/ /%20/g' | sed 's/\n/%0A/g')
            
            FINAL_MSG="${MSG}${LISTA}"

            # 5. Invia a Telegram
            curl -s "https://api.telegram.org/bot$TELEGRAM_TOKEN/sendMessage?chat_id=$TELEGRAM_CHAT_ID&text=$FINAL_MSG&parse_mode=Markdown"

            # 6. Segna come inviato
            curl -X POST "$SUPABASE_URL/rest/v1/config_gara2" \
              -H "apikey: $SUPABASE_KEY" \
              -H "Authorization: Bearer $SUPABASE_KEY" \
              -H "Content-Type: application/json" \
              -H "Prefer: resolution=merge-duplicates" \
              -d "{\"chiave\": \"report_sent\", \"valore\": \"true\"}"
            
            echo "Report inviato con successo."
          else
            echo "Non ancora scaduto o report gia inviato (Status: $REPORT_SENT)."
          fi
